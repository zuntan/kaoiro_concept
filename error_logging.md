# エラーハンドリングとログ (error_logging.md)

`kaoiro` システムの信頼性を確保するための、プラットフォーム別のエラー処理と診断ログの指針。

## 1. エラーハンドリング指針 (Error Handling)

### 1.1. クレートの使い分け
- **`thiserror`**: 各モジュール（`kaoiro-lib`, `kaoiro-desktop` 等）固有の構造化エラーを定義する。
    - 例: `CameraError::DeviceNotFound`, `GestureError::CalibrationFailed`
- **`anyhow`**: アプリケーションのエントリーポイント（`main.rs`, `lib.rs`）で、複数の異なるエラーを集約して報告する際に使用する。

### 1.2. プラットフォーム別の報告方法
- **デスクトップ版**:
    - 起動時の致命的エラーはダイアログ（`native-dialog` 等）で通知。
    - 実行中の警告は UI 上のアバターの表情変化（困り顔）と `StatusLabel` で表現。
- **ブラウザ拡張機能版**:
    - `console.error` への出力。
    - サイドパネル UI 上にエラーメッセージと「再試行」ボタンを表示。

## 2. ログ出力方針 (Logging)

### 2.1. `tracing` クレートによる構造化ログ
スレッド間を跨ぐイベント（カメラ取得 -> 推論 -> 判定）を追跡可能にするため、`tracing` を基盤とする。

### 2.2. ログレベルの定義
| レベル | 内容 | リリース時の扱い |
| :--- | :--- | :--- |
| **ERROR** | システム停止を伴う致命的な障害（カメラ切断、ONNXロード失敗）。 | 常に記録 |
| **WARN** | 処理は継続可能だが、ユーザー体験を損なう問題（認識ジッター、フレームドロップ）。 | 常に記録 |
| **INFO** | 主要なイベント（判定状態の確定、設定変更、MCP接続）。 | 常に記録 |
| **DEBUG** | 開発者向けの内部情報（ランドマーク座標の生データ、計算中間値）。 | 無効化 |

### 2.3. 出力先 (Log Sinks)
- **デスクトップ版**:
    - **標準出力**: 開発時のコンソール。
    - **ファイル出力**: `tracing-appender` を用い、OS標準のログディレクトリ（例: `~/.cache/kaoiro/kaoiro.log`）にローテーション機能付きで保存。
- **ブラウザ拡張機能版**:
    - **Web Console**: `tracing-wasm` を用い、ブラウザのデベロッパーツールで確認可能にする。

## 3. プライバシーと機密情報の保護 (Privacy)

- **画像データの禁止**: ログにカメラの生フレームや、顔画像を特定できるバイナリデータを **決して含めてはならない**。
- **座標データの制限**: `DEBUG` レベルであっても、ログに顔の絶対座標を大量に残すことは避ける。可能な限り、正規化された「ズレ量（Delta）」のみを対象とする。
- **設定値のマスキング**: 万が一 API キー等の機密情報を将来的に扱う場合は、ログ出力時に必ずマスキングを行う。

## 4. 診断とサポート

- **ログのエクスポート**: デスクトップ版の設定画面において、「ログファイルを開く」または「ログフォルダを表示」する機能を設ける。
- **バージョン情報の付与**: 全てのログの冒頭に、アプリケーションのバージョン、OS、ビルド情報を自動的に記録する。
